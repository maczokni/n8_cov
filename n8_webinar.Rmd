---
title: "Changes to police demand in COVID-19 pandemic"
subtitle: "N8PRP Webinar"
author: "RÃ©ka Solymosi, Matt Ashby, Eon Kim, Nadia Kennar, Karen Byrom, Alex McMillan, Phoebe Liebelt"
institute: "University of Manchester, Cheshire Constabulary, UCL"
date: "24/03/2022"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false

---
class: center, middle

# Aim

Explore changes over the pandemic and associated lockdowns in calls to service and response

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, echo = FALSE, include = TRUE, 
                      message = FALSE, warning = FALSE)

library(lubridate)
library(tidyverse)
library(tsibble)
library(sf)

all_calls <- read_rds("/Volumes/n8_covid/all_calls_forecast.Rds")
call_forecasts <- read_rds("/Volumes/n8_covid/call_forecasts.Rds")
all_rt_forecast <- read_rds("/Volumes/n8_covid/all_resp_time_forecast.Rds")
by_type_rt_forecast <- read_rds("/Volumes/n8_covid/by_type_rt_forecasts.Rds")
by_grade_rt_forecast <- read_rds("/Volumes/n8_covid/by_grade_rt_forecasts.Rds")
all_calls_attended_forecast <- read_rds("/Volumes/n8_covid/all_attended_forecasts.Rds")
by_type_attended_forecast <- read_rds("/Volumes/n8_covid/by_type_attended_forecasts.Rds")
attended_by_grade_forecast <- read_rds("/Volumes/n8_covid/attended_by_grade_forecasts.Rds")
domestic_by_grade_volume_forecasts <- read_rds("/Volumes/n8_covid/domestic_by_grade_volume_forecasts.Rds")
domestic_by_grade_rt_forecast <- read_rds("/Volumes/n8_covid/domestic_by_grade_rt_forecasts.Rds")
domestic_by_grade_attended_forecasts <- read_rds("/Volumes/n8_covid/domestic_by_grade_attended_forecasts.Rds")
by_grade_tos_forecasts <- read_rds("/Volumes/n8_covid/by_grade_tos_forecasts.Rds")
cheshire_lsoas <- st_read("cheshire_lsoas.geojson")
lsoa_filler <- bind_rows(data.frame(lsoa = unique(cheshire_lsoas$LSOA11NM),
                          pre_post = "Pre-COVID"), 
                         data.frame(lsoa = unique(cheshire_lsoas$LSOA11NM),
                          pre_post = "2020"))
total_calls_by_imd <- read_csv("/Volumes/n8_covid/total_calls_by_imd.csv")
weekly_count_by_lsoa <- read_csv("/Volumes/n8_covid/weekly_count_by_lsoa.csv")
weekly_asb_by_lsoa <- read_csv("/Volumes/n8_covid/weekly_asb_by_lsoa.csv")

# Note important dates
# Source: https://www.instituteforgovernment.org.uk/sites/default/files/timeline-lockdown-web.pdf
dates <- tribble(
  ~date, ~event,
  "2020-01-31", "first UK COVID case",
  "2020-03-23", "first lockdown begins",
  "2020-06-15", "first lockdown ends",
  "2020-11-05", "second lockdown begins",
  "2020-12-02", "second lockdown ends"
) %>% 
  mutate(
    date = as_date(yearweek(ymd(date))), 
    row = row_number(),
    label = str_glue("{row}. {event}")
  )

forecast_chart <- function (forecasts, variable, value) {
  

  # get forecast type to string
  df_name <- deparse(substitute(forecasts))
  
  # conditionally label y axis
  y_axis_label <- case_when(df_name %in% c("by_type_rt_forecast", 
                                           "by_grade_rt_forecast", 
                                           "domestic_by_grade_rt_forecast") ~ "Median response time (in minutes)", 
                         df_name %in% c("call_forecasts", 
                                        "domestic_by_grade_volume_forecasts") ~ "Weekly count of calls for service", 
                         df_name %in% c("by_type_attended_forecast",
                                        "attended_by_grade_forecast", 
                                        "domestic_by_grade_attended_forecasts") ~ "Weekly % of calls attended", 
                         df_name %in% c("by_grade_tos_forecasts") ~ "Median time on scene (in minutes)")
  
  
  # conditionally find actual value column
  actual_col_name <- case_when(df_name %in% c("by_type_rt_forecast", 
                                           "by_grade_rt_forecast",
                                           "domestic_by_grade_rt_forecast") ~ "actual_rt", 
                         df_name %in% c("call_forecasts",
                                        "domestic_by_grade_volume_forecasts") ~ "actual_calls", 
                         df_name %in% c("by_type_attended_forecast",
                                        "attended_by_grade_forecast", 
                                        "domestic_by_grade_attended_forecasts") ~ "actual_attended", 
                         df_name %in% c("by_grade_tos_forecasts") ~ "actual_tos")
  
  forecasts %>% 
    filter(eval(as.symbol(variable)) %in% value) %>% 
    # Occasionally the ARIMA model may produce forecast confidence intervals
    # that are less than zero, which will not show up on the plot because we
    # have set the y axis to start at zero (to make changes in vertical position
    # on the axis representative of changes in magnitude). To deal with this we
    # will manually set the lower CI of the forecasts to be zero if it is less
    # than zero in the original forecast.
    mutate(forecast_lower = ifelse(forecast_lower < 0, 0, forecast_lower)) %>% 
    ggplot() +
    # Forecast
    geom_ribbon(
      aes(incident_week, ymin = forecast_lower, ymax = forecast_upper), 
      na.rm = TRUE,
      alpha = 0.5, 
      fill = "grey80"
    ) +
    geom_line(aes(incident_week, forecast_mean), na.rm = TRUE, linetype = "22") +
    # Dates of interest
    geom_vline(aes(xintercept = date), data = dates, linetype = "12") +
    geom_label(aes(date, 0, label = row), data = dates, colour = "grey20") +
    # Actual calls
    geom_line(aes(incident_week, eval(as.symbol(actual_col_name)))) +
    geom_point(aes(incident_week, eval(as.symbol(actual_col_name)), fill = sig), shape = 21) +
    scale_x_date(date_labels = "%e %b\n%Y", 
                 limits = as.Date(c("2020-01-06", "2020-12-21")))+
    scale_y_continuous(limits = c(0, NA), labels = scales::comma_format()) +
    scale_fill_manual(values = c(`TRUE` = "black", `FALSE` = "grey80")) +
    labs(
      title = value,
      subtitle = "",
      caption = "Forecast calculated using data up to 31 January 2020",
      x = NULL,
      y = y_axis_label,
      fill = "Actual observed value significantly different from forecast"
    ) +
    theme_minimal() +
    theme(legend.position = "bottom", plot.title = element_text(face = "bold"))
  
}


```

---
class: center, middle

# Overview

## 3 themes

- Call types
- Police response
- Origin of calls

---

# Calls

```{r totalcallsfig, fig.width=11,fig.height=7}

# Total calls fig
all_calls %>% 
 mutate(forecast_lower = ifelse(forecast_lower < 0, 0, forecast_lower)) %>% 
  ggplot() +
  # Forecast
  geom_ribbon(
    aes(incident_week, ymin = forecast_lower, ymax = forecast_upper), 
    na.rm = TRUE,
    alpha = 0.5, 
    fill = "grey80"
  ) +
  geom_line(aes(incident_week, forecast_mean), na.rm = TRUE, linetype = "22") +
  # Dates of interest
  geom_vline(aes(xintercept = date), data = dates, linetype = "12") +
  geom_label(aes(date, 0, label = row), data = dates, colour = "grey20") +
  # Actual calls
  geom_line(aes(incident_week, actual_calls)) +
  geom_point(aes(incident_week, actual_calls, fill = sig), shape = 21) +
  scale_x_date(date_labels = "%e %b\n%Y", 
               limits = as.Date(c("2020-01-06", "2020-12-21"))) +
  scale_y_continuous(limits = c(0, NA), labels = scales::comma_format()) +
  scale_fill_manual(values = c(`TRUE` = "black", `FALSE` = "grey80")) +
  labs(
    title = "Change in all calls for service during 2020 \ncompared to pre-pandemic forecast",
    subtitle = str_wrap(
      str_glue("Events by week: ", str_c(pull(dates, label), collapse = "; ")), 
      80
    ),
    caption = "Forecast calculated using data up to 31 January 2020",
    x = NULL,
    y = "Weekly number of calls",
    fill = "actual calls significantly different from forecast"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom", 
        plot.title = element_text(face = "bold"), 
        text = element_text(size = 20)) +
  xlim(c(min(all_calls$incident_week), ymd("2020-12-14")))

```

---

Add call volume by grade? 

---

# Call types: Quiet roads

```{r quietroadsplots, fig.width=11,fig.height=8}


p1 <- forecast_chart(call_forecasts, "incident_type_new" ,"traffic collision") + 
  labs(title = "Traffic Collision",
      subtitle = "",
      caption = "",
      x = NULL,
      y = NULL,
      fill = NULL) + 
  guides(fill="none")
p2 <- forecast_chart(call_forecasts, "incident_type_new" ,"Highway Disruption")+ 
  labs(subtitle = "", caption = "", x = NULL, fill = NULL) + 
  guides(fill="none")
p3 <- forecast_chart(call_forecasts, "incident_type_new" ,"Road Related Traffic Offence")  +
  labs(subtitle = "",
      caption = "Forecast calculated using data up to 31 January 2020",
      x = NULL,
      y = NULL,
      fill = "Actual observed value significantly different from forecast")

gridExtra::grid.arrange(p1, p2, p3, ncol = 1)


```

---

# Call types: Expressions of concern


```{r asbplot, fig.width=11,fig.height=8}

p1 <- forecast_chart(call_forecasts, "incident_type_new", "ASB") + 
  labs(subtitle = "",
      caption = "",
      x = NULL,
      y = NULL,
      fill = NULL) + 
  guides(fill="none")
p2 <- forecast_chart(call_forecasts, "incident_type_new", "Drugs")

gridExtra::grid.arrange(p1, p2, ncol = 1)


```



---

# Call types: Presence of guardians/ absence of targets


```{r guardiansplot1, fig.width=11,fig.height=8}

forecast_chart(call_forecasts, "incident_type_new", "Burglary - Residential") 

```

---

# Call types: Presence of guardians/ absence of targets


```{r guardiansplot2, fig.width=11,fig.height=7}


p1 <- forecast_chart(call_forecasts, "incident_type_new", "Theft From Motor Vehicle") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")
p2 <- forecast_chart(call_forecasts, "incident_type_new", "Theft Of Motor Vehicle") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")
p3 <- forecast_chart(call_forecasts, "incident_type_new", "Theft Other")

gridExtra::grid.arrange(p1, p2,p3, ncol = 1)

```

---

# Call types: Presence of guardians/ absence of targets


```{r guardiansplot3, fig.width=11,fig.height=7}


p1 <- forecast_chart(call_forecasts, "incident_type_new", "Shoplifting") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")
p2 <- forecast_chart(call_forecasts, "incident_type_new", "Robbery") 

gridExtra::grid.arrange(p1, p2, ncol = 1)

```


---

# Call types: Domestic incidents

```{r domesticfig, fig.width=11,fig.height=7}

# domestic fig
forecast_chart(call_forecasts, "incident_type_new", "Domestic Incident")


```


---

# Call types: Domestic incidents
This does not change when we break down by grade of call.

```{r domesticbygradefig, fig.width=11,fig.height=7}

# Domestic by grade fig

p1 <- forecast_chart(domestic_by_grade_volume_forecasts,"initial_grade_of_response", "Grade 1")
p2 <- forecast_chart(domestic_by_grade_volume_forecasts,"initial_grade_of_response", "Grade 2") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")
p3 <- forecast_chart(domestic_by_grade_volume_forecasts,"initial_grade_of_response", "Grade 3") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")
p4 <- forecast_chart(domestic_by_grade_volume_forecasts,"initial_grade_of_response", "Grade 4") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")

gridExtra::grid.arrange(p1, p2,p3, p4, ncol = 2)



```

---

# Call types: Domestic incidents

Include here some comments from interviews about

> No evidence of "can't talk partner present"

> Shift in topic (more parent vs child)

---

# Police response: Attendance rate


```{r allattendedfig, fig.width=11,fig.height=7}

# % attended fig and response time fig
all_calls_attended_forecast %>% 
    mutate(forecast_lower = ifelse(forecast_lower < 0, 0, forecast_lower)) %>% 
    ggplot() +
    # Forecast
    geom_ribbon(
      aes(incident_week, ymin = forecast_lower, ymax = forecast_upper), 
      na.rm = TRUE,
      alpha = 0.5, 
      fill = "grey80"
    ) +
    geom_line(aes(incident_week, forecast_mean), na.rm = TRUE, linetype = "22") +
    # Dates of interest
    geom_vline(aes(xintercept = date), data = dates, linetype = "12") +
    geom_label(aes(date, 0, label = row), data = dates, colour = "grey20") +
    # Actual calls
    geom_line(aes(incident_week, actual_attended)) +
    geom_point(aes(incident_week, actual_attended, fill = sig), shape = 21) +
    scale_x_date(date_labels = "%e %b\n%Y", 
               limits = as.Date(c("2020-01-06", "2020-12-21"))) +
    scale_y_continuous(limits = c(0, NA), labels = scales::comma_format()) +
    scale_fill_manual(values = c(`TRUE` = "black", `FALSE` = "grey80")) +
    labs(
      title = "Attendance rate for all calls for service during 2020 compared to pre-pandemic forecast",
      subtitle = str_wrap(
        str_glue("Events by week: ", str_c(pull(dates, label), collapse = "; ")), 
        80
      ),
      caption = "Forecast calculated using data up to 31 January 2020",
      x = NULL,
      y = "weekly % of calls attended",
      fill = "actual % significantly different from forecast"
    ) +
    theme_minimal() +
    theme(legend.position = "bottom", plot.title = element_text(face = "bold"))
  


```

---

# Police response: Attendance rate

```{r bygradeattendedperc, fig.width=11,fig.height=7}

p1 <- forecast_chart(attended_by_grade_forecast,"initial_grade_of_response", "Grade 1") + 
  labs(subtitle = "", caption = "", x = NULL, fill = NULL) + 
  guides(fill="none")
p2 <- forecast_chart(attended_by_grade_forecast,"initial_grade_of_response", "Grade 2") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")
p3 <- forecast_chart(attended_by_grade_forecast,"initial_grade_of_response", "Grade 3") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")
p4 <- forecast_chart(attended_by_grade_forecast,"initial_grade_of_response", "Grade 4") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")

gridExtra::grid.arrange(p1, p2, p3, p4, ncol = 2)


```

---

# Police response: Response time

```{r allresptimefig, fig.width=11,fig.height=8}

all_rt_forecast %>% 
    mutate(forecast_lower = ifelse(forecast_lower < 0, 0, forecast_lower)) %>% 
    ggplot() +
    # Forecast
    geom_ribbon(
      aes(incident_week, ymin = forecast_lower, ymax = forecast_upper), 
      na.rm = TRUE,
      alpha = 0.5, 
      fill = "grey80"
    ) +
    geom_line(aes(incident_week, forecast_mean), na.rm = TRUE, linetype = "22") +
    # Dates of interest
    geom_vline(aes(xintercept = date), data = dates, linetype = "12") +
    geom_label(aes(date, 0, label = row), data = dates, colour = "grey20") +
    # Actual calls
    geom_line(aes(incident_week, actual_rt)) +
    geom_point(aes(incident_week, actual_rt, fill = sig), shape = 21) +
    scale_x_date(date_labels = "%e %b\n%Y") +
    scale_y_continuous(limits = c(0, NA), labels = scales::comma_format()) +
    scale_fill_manual(values = c(`TRUE` = "black", `FALSE` = "grey80")) +
    labs(
      title = "Median response time for all calls for service during 2020 compared to pre-pandemic forecast",
      caption = "Forecast calculated using data up to 31 January 2020",
      x = NULL,
      y = "Median response time in minutes",
      fill = "Response time significantly different from forecast"
    ) +
    theme_minimal() +
    theme(legend.position = "bottom", plot.title = element_text(face = "bold"))

```

---

# Police response: Response time

```{r bygraderesptime, fig.width=11,fig.height=7}

p1 <- forecast_chart(by_grade_rt_forecast,"initial_grade_of_response", "Grade 1") + 
  labs(subtitle = "", caption = "", x = NULL, fill = NULL) + 
  guides(fill="none")
p2 <- forecast_chart(by_grade_rt_forecast,"initial_grade_of_response", "Grade 2") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")
p3 <- forecast_chart(by_grade_rt_forecast,"initial_grade_of_response", "Grade 3") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")
p4 <- forecast_chart(by_grade_rt_forecast,"initial_grade_of_response", "Grade 4") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")

gridExtra::grid.arrange(p1, p2, p3, p4, ncol = 2)


```

---

# Police response: Time on scene

Need alltogether time on scene graph here

---

# Police response: Time on scene

```{r bygradetos, fig.width=11,fig.height=7}

p1 <- forecast_chart(by_grade_tos_forecasts,"initial_grade_of_response", "Grade 1") + 
  labs(subtitle = "", caption = "", x = NULL, fill = NULL) + 
  guides(fill="none")
p2 <- forecast_chart(by_grade_tos_forecasts,"initial_grade_of_response", "Grade 2") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")
p3 <- forecast_chart(by_grade_tos_forecasts,"initial_grade_of_response", "Grade 3") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")
p4 <- forecast_chart(by_grade_tos_forecasts,"initial_grade_of_response", "Grade 4") + 
  labs(subtitle = "", caption = "", x = NULL, y = NULL, fill = NULL) + 
  guides(fill="none")

gridExtra::grid.arrange(p1, p2, p3, p4, ncol = 2)


```

---

# Origin of calls: IMD

```{r totalimd, fig.width=11,fig.height=7}


labs_df <- total_calls_by_imd  %>% 
  group_by(index_of_multiple_deprivation_imd_decile) %>% count()

ggplot(total_calls_by_imd , aes(x = as.factor(index_of_multiple_deprivation_imd_decile), y = n )) + 
  geom_boxplot(aes(fill = as.factor(index_of_multiple_deprivation_imd_decile)), alpha = 0.8) + 
  geom_label(data = labs_df, aes(x = index_of_multiple_deprivation_imd_decile, y = 50000, label = paste0("n = ",n))) + 
  scale_fill_brewer(palette = "RdYlBu") + 
  scale_y_log10() + 
  labs(title = "Total calls from LSOAs in each IMD decile 2015-2020") + 
  xlab("IMD decile (1 = most and 10 = least deprived)") + 
  ylab("Number of calls (all types)") + 
  labs(fill = "IMD") + 
  theme_bw()

```

---

# Origin of calls: IMD 

```{r imdchange, fig.width=11,fig.height=7}


plot_imds <- function(weekly_count_by_lsoa) {
  
  
  firstweek <- min(weekly_count_by_lsoa$inc_wk)
lastweek <- max(weekly_count_by_lsoa$inc_wk)


weekly_count_by_lsoa <- weekly_count_by_lsoa %>% 
  filter(inc_wk > firstweek & inc_wk < lastweek) 

num_lsoa_per_decile <- weekly_count_by_lsoa %>% 
  select(lsoa, index_of_multiple_deprivation_imd_decile) %>% 
  distinct() %>% 
  group_by(index_of_multiple_deprivation_imd_decile) %>% 
  count() %>% 
  rename(num_lsoas = n)

thing <- weekly_count_by_lsoa %>% 
  left_join(., num_lsoa_per_decile, by = c("index_of_multiple_deprivation_imd_decile" = "index_of_multiple_deprivation_imd_decile")) %>% 
  select(inc_wk, n, index_of_multiple_deprivation_imd_decile, num_lsoas)  %>% 
  group_by(inc_wk, index_of_multiple_deprivation_imd_decile, num_lsoas) %>%
  summarise(n = sum(n)) %>%
  mutate(calls_per_lsoa = n/num_lsoas) %>% 
  group_by(inc_wk, index_of_multiple_deprivation_imd_decile) %>%
  summarise(calls_per_lsoa = calls_per_lsoa) %>% 
    mutate(percentage = calls_per_lsoa / sum(calls_per_lsoa))

# Plot
ggplot(thing, aes(x=inc_wk, y=percentage, fill=as.factor(index_of_multiple_deprivation_imd_decile))) + 
    geom_area(alpha= 1 , size=0.001, colour="black") +
  # First UK case
  geom_vline(xintercept = as.Date("2020-01-23"), linetype = "33") +
  # First UK lockdown begins
  geom_vline(xintercept = as.Date("2020-03-23"), linetype = "12") +
  # First UK lockdown ends
  geom_vline(xintercept = as.Date("2020-06-01"), linetype = "42") +
  geom_label(aes(as.Date("2020-01-23"), 0, label = "1"), fill = "white", colour = "grey20", nudge_y = -0.05) +
  geom_label(aes(as.Date("2020-03-23"), 0, label = "2"), fill = "white", colour = "grey20", nudge_y = -0.05) +
  geom_label(aes(as.Date("2020-06-01"), 0, label = "3"), fill = "white", colour = "grey20", nudge_y = -0.05) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b\n%Y", expand = c(0, 0)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_brewer(type = "qual", palette = "RdYlBu") + 
  labs(
    title = "Proportion of Calls from different IMD deciles",
    subtitle = "1: First UK Case, 2: Lockdown begins, 3: Lockdown ends",
    x = NULL,
    y = "Proportion",
    fill = "IMD decile"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom") +    guides(fill=guide_legend(nrow=1,byrow=TRUE))
  
}


plot_imds(weekly_count_by_lsoa)

```



---

# Origin of calls: IMD for ASB calls

```{r}

plot_imds(weekly_asb_by_lsoa)

```


